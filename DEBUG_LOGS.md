# 调试日志使用说明

本项目已内置详细的调试日志系统，可以帮助你快速定位和解决问题。

## 目录

- [启用/禁用调试日志](#启用禁用调试日志)
- [日志类型说明](#日志类型说明)
- [查看调试日志](#查看调试日志)
- [日志输出示例](#日志输出示例)
- [常见调试场景](#常见调试场景)
- [性能分析](#性能分析)

---

## 启用/禁用调试日志

### 默认状态

调试日志**默认启用**，所有操作都会在浏览器控制台输出详细信息。

### 禁用调试日志

如果你想禁用调试日志（例如在生产环境），可以修改 `assets/js/script.js` 文件：

```javascript
// 在文件开头找到这一行
const DEBUG = {
  enabled: true,  // 改为 false 即可禁用所有调试日志
  // ...
};
```

或者在浏览器控制台临时禁用：

```javascript
// 临时禁用（刷新页面后恢复）
DEBUG.enabled = false;

// 重新启用
DEBUG.enabled = true;
```

---

## 日志类型说明

调试系统提供了多种日志类型，每种类型都有不同的图标和颜色：

| 类型 | 图标 | 用途 | 示例 |
|------|------|------|------|
| `DEBUG.log()` | 🔍 | 一般信息 | 记录函数调用、变量值 |
| `DEBUG.info()` | ℹ️ | 提示信息 | 重要的状态变化 |
| `DEBUG.success()` | ✅ | 成功操作 | 配置保存成功、请求成功 |
| `DEBUG.warn()` | ⚠️ | 警告信息 | 配置不完整、JSON 解析失败 |
| `DEBUG.error()` | ❌ | 错误信息 | 请求失败、异常捕获 |
| `DEBUG.group()` | 🔍 | 分组开始 | 将相关日志分组显示 |
| `DEBUG.groupEnd()` | - | 分组结束 | 结束分组 |
| `DEBUG.table()` | - | 表格显示 | 以表格形式显示数据 |
| `DEBUG.time()` | ⏱️ | 计时开始 | 测量操作耗时 |
| `DEBUG.timeEnd()` | ⏱️ | 计时结束 | 显示耗时结果 |

---

## 查看调试日志

### 1. 打开浏览器控制台

- **Chrome/Edge**: 按 `F12` 或 `Ctrl+Shift+I`
- **Firefox**: 按 `F12` 或 `Ctrl+Shift+I`
- **Safari**: 按 `Cmd+Option+I`

### 2. 切换到 Console 标签

所有调试日志都会输出到控制台的 Console 标签。

### 3. 过滤日志

使用控制台的过滤功能快速查找特定日志：

- 输入 `🔍` 查看所有一般日志
- 输入 `✅` 查看所有成功日志
- 输入 `❌` 查看所有错误日志
- 输入 `网络请求` 查看所有网络相关日志
- 输入 `配置` 查看所有配置相关日志

### 4. 展开/折叠分组

点击分组标题左侧的箭头可以展开或折叠日志分组。

---

## 日志输出示例

### 页面加载

```
ℹ️ 脚本开始加载
ℹ️ 页面加载完成，开始初始化
⏱️ 页面初始化: 开始计时
🔍 初始化密码切换功能
🔍 应用默认配置
🔍 加载配置从 LocalStorage
✅ 配置加载成功，共 2 个配置
┌─────────┬──────────────┬─────────────────────┬──────────┬────┐
│ (index) │     名称     │         URL         │   模型   │默认│
├─────────┼──────────────┼─────────────────────┼──────────┼────┤
│    0    │ 'OpenAI 生产' │ 'https://api.openai.com' │ 'gpt-4' │ '是' │
│    1    │ 'Gemini 测试' │ 'https://generativelanguage.googleapis.com' │ 'gemini-pro' │ '否' │
└─────────┴──────────────┴─────────────────────┴──────────┴────┘
✅ 找到默认配置: OpenAI 生产
🔍 应用默认配置
  🔍 API URL: https://api.openai.com
  🔍 API Key: sk-proj...xyz
  🔍 Model: gpt-4
🔍 设置默认用户消息: 当前时间是？
⏱️ 页面初始化: 15.234ms
✅ 页面初始化完成
```

### 测试请求

```
🔍 ========== 开始测试 ==========
⏱️ 测试总耗时: 开始计时
🔍 测试配置
  🔍 API URL: https://api.openai.com
  🔍 API Key: sk-proj...xyz
  🔍 Model: gpt-4
ℹ️ 测试场景: openai_tools
🔍 用户消息: 当前时间是？
🔍 OpenAI 工具调用测试
  🔍 步骤 1: 发送带工具定义的请求
  🔍 发送第一次请求...
  🔍 网络请求
    ⏱️ 请求耗时: 开始计时
    🔍 请求 URL: https://api.openai.com/v1/chat/completions
    🔍 请求方法: POST
    🔍 请求头
      🔍 Content-Type: application/json
      🔍 Authorization: Bearer sk-proj...xyz
    🔍 请求体大小: 245 字节
    🔍 请求体预览: {
      "model": "gpt-4",
      "messages": [
        {
          "role": "user",
          "content": "当前时间是？"
        }
      ],
      "tools": [...]
    }
    🔍 响应状态: 200 OK
    🔍 响应 OK: true
    🔍 Content-Type: application/json
    🔍 响应大小: 512 字节
    ✅ JSON 解析成功
    🔍 JSON 预览: {
      "id": "chatcmpl-xxx",
      "object": "chat.completion",
      "choices": [...]
    }
    ⏱️ 请求耗时: 1234.56ms
  ✅ 响应包含有效 JSON
  🔍 助手消息: { role: 'assistant', content: null, tool_calls: [...] }
  ✅ 检测到工具调用: get_current_time
  🔍 工具调用 ID: call_abc123
  🔍 工具参数: {}
  🔍 步骤 2: 模拟工具执行
  🔍 当前时间: 2025年10月21日 星期二 14:30:45
  🔍 步骤 3: 发送工具结果，获取最终回答
  🔍 网络请求
    ...
  ✅ 获得最终回答
  🔍 最终回答内容: 现在是2025年10月21日 星期二 14:30:45
⏱️ 测试总耗时: 2567.89ms
🔍 ========== 测试结束 ==========
```

### 配置管理

```
🔍 保存配置按钮点击
🔍 配置信息
  🔍 名称: 我的配置
  🔍 URL: https://api.openai.com
  🔍 Key: sk-test...456
  🔍 Model: gpt-4
🔍 添加新配置
🔍 保存配置到 LocalStorage，共 3 个配置
✅ 配置保存成功
🔍 显示配置列表
🔍 加载配置从 LocalStorage
✅ 配置加载成功，共 3 个配置
✅ 配置保存成功
```

### 错误处理

```
❌ 测试过程中发生错误: Error: HTTP 401
🔍 错误详情
  🔍 错误消息: HTTP 401
  🔍 错误状态码: 401
  🔍 Content-Type: application/json
  🔍 响应文本长度: 156
  🔍 响应文本预览: {"error":{"message":"Incorrect API key provided","type":"invalid_request_error"}}
❌ Error: HTTP 401
    at fetchAndParse (script.js:1023)
    at async HTMLButtonElement.<anonymous> (script.js:756)
```

---

## 常见调试场景

### 场景 1：请求失败

**问题**：API 请求返回错误

**查看日志**：
1. 打开控制台
2. 查找 `❌ 测试过程中发生错误`
3. 展开 `错误详情` 分组
4. 检查：
   - 错误状态码（401, 403, 500 等）
   - 响应文本内容
   - Content-Type 是否为 JSON

**常见错误**：
- `401 Unauthorized`: API Key 错误或无效
- `404 Not Found`: API URL 错误
- `响应非 JSON`: 返回了 HTML 页面，可能是 URL 错误

### 场景 2：未触发工具调用

**问题**：模型没有调用工具

**查看日志**：
1. 查找 `⚠️ 未检测到工具调用`
2. 查看 `助手消息内容`
3. 检查模型是否理解了用户消息

**解决方法**：
- 修改用户消息，使其更明确
- 检查模型是否支持工具调用
- 查看完整的响应内容

### 场景 3：配置加载失败

**问题**：配置无法加载或保存

**查看日志**：
1. 查找 `❌ 配置加载失败` 或 `❌ 配置保存失败`
2. 检查错误信息
3. 查看 LocalStorage 是否被禁用

**解决方法**：
- 检查浏览器是否允许 LocalStorage
- 清除浏览器缓存
- 检查配置数据格式是否正确

### 场景 4：网络请求慢

**问题**：请求响应时间过长

**查看日志**：
1. 查找 `⏱️ 请求耗时`
2. 查看具体耗时（单位：毫秒）
3. 检查网络连接

**正常范围**：
- 国内 API：500-2000ms
- 国外 API：1000-5000ms
- 超过 10000ms 可能有问题

---

## 性能分析

### 查看总耗时

每次测试都会记录总耗时：

```
⏱️ 测试总耗时: 2567.89ms
```

### 查看单个请求耗时

每个网络请求都会记录耗时：

```
⏱️ 请求耗时: 1234.56ms
```

### 查看页面初始化耗时

页面加载时会记录初始化耗时：

```
⏱️ 页面初始化: 15.234ms
```

### 性能优化建议

如果发现性能问题：

1. **请求耗时过长**：
   - 检查网络连接
   - 考虑使用更近的 API 服务器
   - 检查是否有代理或 VPN 影响

2. **页面初始化慢**：
   - 检查配置数量（过多配置会影响加载）
   - 清理 LocalStorage
   - 检查浏览器扩展是否影响

3. **多次请求累积**：
   - OpenAI/Claude/Gemini 工具调用需要 2 次请求
   - 总耗时 = 请求1耗时 + 请求2耗时 + 处理时间

---

## 高级调试技巧

### 1. 导出日志

在控制台右键点击日志，选择 **Save as...** 可以导出日志到文件。

### 2. 复制日志

右键点击日志，选择 **Copy** 可以复制日志内容。

### 3. 过滤特定日志

使用控制台的过滤框：

```
// 只显示错误
-🔍 -ℹ️ -✅ -⚠️

// 只显示网络请求
网络请求

// 只显示配置相关
配置
```

### 4. 清空控制台

- 点击控制台左上角的 🚫 图标
- 或按 `Ctrl+L`
- 或在控制台输入 `clear()`

### 5. 保留日志

勾选控制台的 **Preserve log** 选项，可以在页面刷新后保留日志。

---

## 调试日志 API 参考

如果你需要在代码中添加自定义日志，可以使用以下 API：

```javascript
// 一般日志
DEBUG.log('这是一条日志', variable);

// 信息日志
DEBUG.info('重要信息');

// 成功日志
DEBUG.success('操作成功');

// 警告日志
DEBUG.warn('警告信息');

// 错误日志
DEBUG.error('错误信息', error);

// 分组日志
DEBUG.group('分组标题');
DEBUG.log('分组内的日志');
DEBUG.groupEnd();

// 表格显示
DEBUG.table([
  { name: 'Alice', age: 25 },
  { name: 'Bob', age: 30 }
]);

// 计时
DEBUG.time('操作名称');
// ... 执行操作
DEBUG.timeEnd('操作名称');

// 安全显示 API Key
DEBUG.log('API Key:', DEBUG.maskApiKey(apiKey));
```

---

## 常见问题

### Q: 为什么看不到日志？

**A**: 检查以下几点：
1. 是否打开了浏览器控制台
2. 是否切换到了 Console 标签
3. `DEBUG.enabled` 是否为 `true`
4. 控制台过滤器是否过滤了日志

### Q: 日志太多，如何只看重要的？

**A**: 使用过滤功能：
- 只看错误：输入 `❌`
- 只看警告：输入 `⚠️`
- 只看成功：输入 `✅`
- 折叠不重要的分组

### Q: 如何在生产环境禁用日志？

**A**: 修改 `script.js`：
```javascript
const DEBUG = {
  enabled: false,  // 设置为 false
  // ...
};
```

或者使用环境变量（需要构建工具支持）：
```javascript
const DEBUG = {
  enabled: process.env.NODE_ENV !== 'production',
  // ...
};
```

### Q: 日志会影响性能吗？

**A**: 
- 在开发环境：影响很小，可以忽略
- 在生产环境：建议禁用日志以获得最佳性能
- 日志本身的开销通常小于 1ms

### Q: 如何导出日志用于报告问题？

**A**: 
1. 右键点击控制台
2. 选择 **Save as...**
3. 保存为 `.log` 文件
4. 在 GitHub Issue 中附上日志文件

---

## 总结

调试日志系统可以帮助你：

✅ **快速定位问题**：详细的错误信息和堆栈跟踪  
✅ **理解执行流程**：清晰的步骤和分组  
✅ **性能分析**：精确的耗时统计  
✅ **安全调试**：自动隐藏敏感信息（API Key）  
✅ **易于使用**：无需额外配置，开箱即用  

如果遇到问题，请先查看调试日志，大多数问题都能通过日志快速解决！

---

**最后更新**：2025-10-21
